name: cms_files
label: Attachments
icon: drafts
enable_search: true
enable_api: true
hidden: false
version: 2
fields:
  name:
    label: Name
    type: text
    searchable: true
    index: true
    is_wide: true
    readonly: true
    name: name
  description:
    label: Description
    type: textarea
    is_wide: true
    readonly: true
    name: description
  extention:
    label: Extention
    type: text
    disabled: true
    readonly: true
    name: extention
  size:
    label: Size
    type: filesize
    disabled: true
    name: size
  versions:
    label: History Versions
    type: file
    collection: files
    multiple: true
    visible_on: "{{false}}"
    name: versions
  parent:
    label: Parent
    type: lookup
    readonly: true
    visible_on: "{{global.mode ==='read' ? true : false}}"
    index: true
    reference_to: !<tag:yaml.org,2002:js/function> |- 
      function () {
                return _.keys(Creator.Objects);
            }
    name: parent
    filterable: true
  allow_anonymous_downloads:
    label: Allow Anonymous Downloads
    type: boolean
list_views:
  all:
    columns:
      - field: name
        amis:
          "popOver": {
            "popOverClassName": "min-w-0",
            "trigger": "hover",
            "showIcon": false,
            "body": [
              {
                "type": "steedos-object-button",
                "name": "preview_amis",
                "objectName": "cms_files"
              }]
            }
      - size
      - owner
      - created
      - modified
    extra_columns:
      - versions
    order:
      - - modified
        - asc
    filter_scope: space
permission_set:
  user:
    allowCreate: true
    allowDelete: true
    allowEdit: true
    allowRead: true
    modifyAllRecords: false
    viewAllRecords: true
  admin:
    allowCreate: true
    allowDelete: true
    allowEdit: true
    allowRead: true
    modifyAllRecords: true
    viewAllRecords: true

actions:
  standard_new:
    label: New
    visible: false
  standard_open_view:
    label: Open
    visible: true
  # online_preview:
  #   label: Preview
  #   sort: 110
  #   visible: !<tag:yaml.org,2002:js/function> |-
  #     function (object_name, record_id, record_permissions, record) {
  #             if(!record){
  #               return false;
  #             }
  #             if (Meteor.isCordova){
  #               return false;
  #             }
  #             var file = record;
  #             if (Creator.showPreviewButton(file.name) || Creator.isImageAttachment(file.name) || Creator.isHtmlAttachment(file.name))
  #               return true;
              
  #             return false;
  #           }
  #   'on': record
  preview_amis:
    amis_schema: |-
      {
        "type": "service",
        "body": [
            {
                "type": "button",
                "label": "预览",
                "level": "link",
                "id": "u:preview_amis",
                "onEvent": {
                    "click": {
                        "weight": 0,
                        "actions": [
                            {
                                "ignoreError": false,
                                "actionType": "drawer",
                                "drawer": {
                                    "type": "drawer",
                                    "className": {
                                        "drawer-container-office-preview": true,
                                        "drawer-excel-file": "${ARRAYINCLUDES(['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'],versions[0].type)}"
                                    },
                                    "title": {
                                        "type": "tpl",
                                        "id": "u:63440f27b2fc",
                                        "tpl": "${name}",
                                        "className": "flex justify-center items-center"
                                    },
                                    "body": [
                                      {
                                        "type": "page",
                                        "body": [
                                          {
                                              "type": "office-viewer",
                                              "id": "u:d27be9cc371d",
                                              "wordOptions": {
                                                  "ignoreWidth": false,
                                                  "padding": "",
                                                  "bulletUseFont": true,
                                                  "enableVar": false
                                              },
                                              "src": "/api/files/files/${versions[0]._id}",
                                              "visibleOn": "${ARRAYINCLUDES(['application/vnd.openxmlformats-officedocument.wordprocessingml.document'],versions[0].type)}",
                                              "className": "flex justify-center items-center h-full",
                                              "loading": true
                                          },
                                          {
                                              "type": "office-viewer",
                                              "wordOptions": {
                                                  "ignoreWidth": false,
                                                  "padding": "",
                                                  "bulletUseFont": true,
                                                  "enableVar": false
                                              },
                                              "src": "/api/files/files/${versions[0]._id}",
                                              "visibleOn": "${ARRAYINCLUDES(['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'],versions[0].type)}",
                                              "className": "office-viewer-excel",
                                              "loading": true
                                          },
                                          {
                                              "type": "iframe",
                                              "src": "${context.rootUrl}/api/page/public/pdf_view?fileId=${versions[0]._id}",
                                              "visibleOn": "${ARRAYINCLUDES(['application/pdf'],versions[0].type)}",
                                              "id": "u:dc63f1f2d0ab",
                                              "source": "src"
                                          },
                                          {
                                              "type": "image",
                                              "id": "u:4d9071791016",
                                              "visibleOn": "${ARRAYINCLUDES(['image/jpeg'],versions[0].type)}",
                                              "src": "/api/files/files/${versions[0]._id}",
                                              "imageMode": "original"
                                          }
                                        ],
                                        "bodyClassName": "p-0",
                                        "css": {
                                            ".drawer-container-office-preview .office-viewer-excel": {
                                                "height": "100% !important"
                                            },
                                            ".drawer-excel-file .antd-Page-body>div": {
                                                "height": "100%"
                                            }
                                        }
                                      }
                                    ],
                                    "id": "u:cd1199c49cc7",
                                    "actions": [
                                        {
                                            "type": "button",
                                            "actionType": "cancel",
                                            "label": "关闭",
                                            "id": "u:6f9d5665a14f"
                                        }
                                    ],
                                    "showCloseButton": true,
                                    "closeOnOutside": false,
                                    "closeOnEsc": false,
                                    "showErrorMsg": true,
                                    "showLoading": true,
                                    "draggable": false,
                                    "actionType": "drawer",
                                    "size": "lg",
                                    "resizable": false,
                                    "editorSetting": {
                                        "displayName": ""
                                    },
                                    "position": "right",
                                    "hideActions": false,
                                    "width": "100%",
                                    "themeCss": {
                                        "drawerTitleClassName": {
                                            "font": {
                                                "text-decoration": "underline"
                                            }
                                        }
                                    }
                                }
                            }
                        ]
                    }
                },
                "visibleOn": "${abc}"
            }
        ],
        "data": {
            "context": {},
            "dataComponentId": "",
            "record_id": "",
            "record": {},
            "permissions": {}
        }
      }
    label: 预览
    'on': record
    type: amis_button
    visible: true
  standard_edit:
    label: Edit
    sort: 0
    visible: !<tag:yaml.org,2002:js/function> |-
      function (object_name, record_id, record_permissions, record) {
        return Creator.USER_CONTEXT.user.is_space_admin
      }
    'on': record
    todo: standard_edit
  standard_delete:
    label: Delete
    visible: !<tag:yaml.org,2002:js/function> |-
      function (object_name, record_id, record_permissions, record) {
        if(record_permissions){
          return record_permissions["allowDelete"];
        }
        else{
          var object_fields_keys, ref, select;
          if(!record){
            object_fields_keys = _.keys(((ref = Creator.getObject(object_name, Session.get("spaceId"))) != null ? ref.fields : void 0) || {}) || [];
            select = _.intersection(object_fields_keys, ['owner', 'company_id', 'locked']) || [];
            if (select.length > 0) {
                record = Creator.getObjectRecord(object_name, record_id, select.join(','));
            } else {
                record = {};
            }
            record = Creator.getObjectRecord(object_name, record_id, select.join(','));
          }
          record_permissions = Creator.getRecordPermissions(object_name, record, Meteor.userId());
          return record_permissions && record_permissions["allowDelete"];
        }
      }
    'on': record_more
    todo: standard_delete
  download:
    label: Download
    'on': record
  new_version:
    label: Upgrade
    type: amis_button
    visible: !<tag:yaml.org,2002:js/function> |- 
      function (object_name, record_id, record_permissions, record) {
        if(record_permissions){
          return record_permissions["allowEdit"];
        }
        else{
          var object_fields_keys, ref, select;
          if(!record){
            object_fields_keys = _.keys(((ref = Creator.getObject(object_name, Session.get("spaceId"))) != null ? ref.fields : void 0) || {}) || [];
            select = _.intersection(object_fields_keys, ['owner', 'company_id', 'locked']) || [];
            if (select.length > 0) {
                record = Creator.getObjectRecord(object_name, record_id, select.join(','));
            } else {
                record = {};
            }
            record = Creator.getObjectRecord(object_name, record_id, select.join(','));
          }
          record_permissions = Creator.getRecordPermissions(object_name, record, Meteor.userId());
          return record_permissions && record_permissions["allowEdit"];
        }
      }
    is_file: true
    'on': record_only
    amis_schema: |-
        {
            "type": "service",
            "body": [
                {
                    "type": "form",
                    "title": "表单",
                    "body": [
                        {
                            "type": "input-file",
                            "label": "",
                            "name": "__file",
                            "id": "u:a58d02614e04",
                            "btnLabel": "上传新版本",
                            "btnClassName": "m-0",
                            "className": "p-0",
                            "multiple": false,
                            "maxLength": 10,
                            "submitType": "asUpload",
                            "uploadType": "fileReceptor",
                            "proxy": false,
                            "drag": false,
                            "autoUpload": true,
                            "useChunk": false,
                            "joinValues": false,
                            "extractValue": false,
                            "valueField": "version_id",
                            "receiver": {
                                "url": "${context.rootUrl}/s3/",
                                "headers": {
                                    "Authorization": "Bearer ${context.tenantId},${context.authToken}"
                                },
                                "method": "post",
                                "messages": {},
                                "dataType": "form-data",
                                "requestAdaptor": "const superData = (typeof context != 'undefined') ? context : api.body; api.data.append('record_id', superData._master.recordId);api.data.append('parent', superData._master.recordId);api.data.append('object_name', superData._master.objectName); api.data.append('space', superData.global.spaceId);api.data.append('owner', superData.global.userId);api.data.append('owner_name', superData.global.user.name);return api;",
                                "adaptor": "if(payload.errors && payload.errors.length > 0){payload = {status: 500,msg: payload.errors[0].errorMessage}};return payload;"
                            },
                            "onEvent": {
                                "success": {
                                    "weight": 0,
                                    "actions": [
                                        {
                                            "componentId": "u:a58d02614e04",
                                            "args": {},
                                            "actionType": "clear"
                                        },
                                        {
                                            "componentId": "",
                                            "args": {
                                                "msgType": "success",
                                                "position": "top-right",
                                                "closeButton": true,
                                                "showIcon": true,
                                                "msg": "上传成功"
                                            },
                                            "actionType": "toast"
                                        },
                                        {
                                          "actionType": "reload",
                                          "componentId": "service_detail_page"
                                        },
                                        {
                                          "actionType": "broadcast",
                                          "args": {
                                            "eventName": "@data.changed.cfs_files_filerecord"
                                          }
                                        }
                                    ]
                                },
                                "fail": {
                                "actions": [
                                  {
                                    "actionType": "custom",
                                    "script": "doAction({'actionType': 'toast', 'args': {msgType: 'error', position: 'top-right', closeButton: true, showIcon: true, msg: context.state.error}});"
                                  },
                                    {
                                        "componentId": "u:a58d02614e04",
                                        "args": {},
                                        "actionType": "clear"
                                    }
                                  ]
                                }
                            }
                        }
                    ],
                    "id": "u:5f901c0b917b",
                    "wrapWithPanel": false
                }
            ]
        }
  upload:
    label: Upload
    on: list
    type: amis_button
    visible: !!js/function |
      function(){
        if(arguments.length > 3){
          var ctx = arguments[3];
          if(ctx && ctx._isRelated){
            return ctx.recordPermissions.allowCreateFiles
          }
        }
      }
    amis_schema: |-
        {
            "type": "service",
            "body": [
                {
                    "type": "form",
                    "title": "表单",
                    "body": [
                        {
                            "type": "input-file",
                            "label": "",
                            "name": "__file",
                            "id": "u:a58d02614e04",
                            "btnLabel": "上传",
                            "btnClassName": "m-0",
                            "className": "p-0",
                            "multiple": false,
                            "maxLength": 10,
                            "submitType": "asUpload",
                            "uploadType": "fileReceptor",
                            "proxy": false,
                            "drag": false,
                            "autoUpload": true,
                            "useChunk": false,
                            "joinValues": false,
                            "extractValue": false,
                            "valueField": "version_id",
                            "receiver": {
                                "url": "${context.rootUrl}/s3/",
                                "headers": {
                                    "Authorization": "Bearer ${context.tenantId},${context.authToken}"
                                },
                                "method": "post",
                                "messages": {},
                                "dataType": "form-data",
                                "requestAdaptor": "const superData = (typeof context != 'undefined') ? context : api.body; api.data.append('record_id', superData._master.recordId);api.data.append('object_name', superData._master.objectName); api.data.append('space', superData.global.spaceId);api.data.append('owner', superData.global.userId);api.data.append('owner_name', superData.global.user.name);return api;",
                                "adaptor": "if(payload.errors && payload.errors.length > 0){payload = {status: 500,msg: payload.errors[0].errorMessage}};return payload;"
                            },
                            "onEvent": {
                                "success": {
                                    "weight": 0,
                                    "actions": [
                                        {
                                            "componentId": "u:a58d02614e04",
                                            "args": {},
                                            "actionType": "clear"
                                        },
                                        {
                                            "componentId": "",
                                            "args": {
                                                "msgType": "success",
                                                "position": "top-right",
                                                "closeButton": true,
                                                "showIcon": true,
                                                "msg": "${'cms_files.upload.message_success' | t}"
                                            },
                                            "actionType": "toast"
                                        },
                                        {
                                          "componentId": "",
                                          "args": {},
                                          "actionType": "custom",
                                          "script": "doAction({\n  componentId: `steedos-record-related-list-${context.props.data.objectName}`,\n  actionType: \"setValue\",\n  args: {\n    value: { \"$count\": undefined }\n  }\n}); SteedosUI.getRef(context.props.data.scopeId).parent?.getComponentById(`listview_${context.props.data.objectName}`).handleAction({}, { actionType: 'reload'})"
                                        }
                                    ]
                                },
                                "fail": {
                                "actions": [
                                    {
                                    "actionType": "custom",
                                    "script": "doAction({'actionType': 'toast', 'args': {msgType: 'error', position: 'top-right', closeButton: true, showIcon: true, msg: event.data.error.message}});"
                                  },
                                    {
                                        "componentId": "u:a58d02614e04",
                                        "args": {},
                                        "actionType": "clear"
                                    }
                                  ]
                                }
                            }
                        }
                    ],
                    "id": "u:5f901c0b917b",
                    "wrapWithPanel": false
                }
            ]
        }